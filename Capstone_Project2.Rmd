---
title: "Intro to DS Capstone Project"
author: "Derek J. Dennis"
date: "May 11, 2018"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}

```

## Introduction

The prediction of the outcomes of sports matches garners a lot of interest within the respective leagues.  All major world sports have opportunities for which one can predict the outcome of the match.  Sports wagering is a $90.9 billion dollar global enterprise.  As a subset to this industry, those outlets which can help gamblers predict game outcomes with good accuracy can create significant revenue.  This can be done through subscriptions to periodicals and blogs displaying the appropriate gambling information.  While there has been proven methods to succeed in predicting sports like basketball and baseball, one would be hard pressed to find consistent success in predicting outcomes in American Football.  The goal of the research referenced in this paper is to determine if offensive and defensive formulas developed by the author can predict the outcomes of college football games at a success rate greater than 52.4%.

## Understanding the Goal of the Exercise

There are many different ways to make a prediction on an American Football game.  The two most prevalent of these predictions, which will be the ones that are tested here, are picking against the spread and Over/Under.  The spread is a number generated by a bookmaker that gives the more powerful team a handicap so that the wager can be considered even.  For example:  For the 2017 National Championship Game in College Football, the Alabama Crimson Tide played the Georgia Bulldogs.  The oddsmaker listed the game like this, Alabama (-4) over Georgia.  In other words, Alabama was a four-point favorite against Georgia.  This means if one were to wager on Alabama to win, Alabama would have to win by more than four points, not just win outright.  The actual result of the game was Alabama 26 – Georgia 23 in overtime.  Therefore, the bettors that chose Alabama actually lost the bet.
An Over/Under bet is when the oddsmaker generates a number that is believed to be an accurate prediction of the total amount of points that both teams will score in a game.  The bettor then wagers whether the actual outcome of total points will be more (Over) or less (Under) than that number.  Using the National Championship example:  The Oddsmaker assigned the Over/Under bet to be 45.  Since the two teams combined for 49 points (26+23), the winning bet was Over.
The goal of this exercise is to see if any analysis can net a winning result in outcomes at least 52.4% of the time.  At this point, there needs to be some explanation since the obvious percentage would be better than 50%.  In the betting industry, there is a term called “juice.”  This is the amount of money that is paid to the oddsmaker for every win.  In the National Championship Game, if a bettor wagered $10 dollars on the Alabama Crimson Tide, the bettor would have lost $10.  If the bettor would have wagered that same amount on the Georgia Bulldogs, the bettor would have received $19.10.  That is $10 from the original bet plus an additional $9.10 for the winning wager, not $20 ($10 bet + $10 win).  To illustrate a real world situation:  If someone made 1000 $10 bets and won 500 times (50% success), he would lose $450 instead of break even (500 wins x $19.10 = $9550 - $10000).  If the number of wins was increased to 524 (52.4% success) he would be ahead by $8 (524 wins x $19.10 = $10,008 - $10,000).  Therefore, test results that are better than a 52.4% success rate will yield positive outcomes for bettors.

## Data
A quick look at the starting data can be shown here:
```{r}
chunk1 <- read.csv("Capstone CFA Scores and Lines.csv")
str(chunk1)

```


The fields included in this data frame are:
1. Year - The year that the game was played
2. Week - The numbered week during the particular year that the game was played
3. Away Team - The team that traveled to the game in question
4. Home Team - The team that away team is playing against
5. Line - As explained earlier, the oddsmaker's handicap to make this an even bet
6. Over/Under - The oddsmaker's guess as to the total number of points that will be scored in the game.  
7. ATOR - Offensive ranking for the away team
8. ATDR - Defensive ranking for the away team
9. HTOR - Offensive ranking for the home team
10. HTDR - Defensive ranking for the home team
11. Score - Final score of the game

The rankings for listings 7-10 were developed using standard data from the results from previous college football game results.  Some of this data include:  passing completions, rushing yards, turnovers and touchdowns.  This data was obtained from ncaasports.com and cfbstats.com.  Other data such as the scores and the teams playing were obtained from espn.com.

## Data Wrangling

Fortunately, the data was mostly neat at the time it was transfered to R as a .csv file.  There were a few alterations: The score had to be expanded so that each column had the away team and home team result.  This is so calculations on the total points could be done later.  There would also be some filtering of the neutral column do that calculations can be performed on the success rate of the algorithm at a neutral site.  Finally, the Over/Under column will be filtered so that we can do statistical testing vs that particular number.

```{r}
chunk2 <- read.csv("dfCapTidy.csv")
str(chunk2)

```


## Statistical Analysis

One of the main points of this study is to see if the developed ratings would be robust enough to use for all of the calculations.  The best way to do this is to compare the calculations to the points scored for each team and the points they allowed at the end of each respective seasons over the eight year span.  To do this, a linear regression will be performed.  Two graphs will be plotted to show points scored (allowed) per season vs final team rating for offense and defense.  The results are below.

```{r}
library(ggplot2)
chunkdef <- read.csv("DefGraph.csv")
defgraph <- lm(DefScore ~ DefRate, data = chunkdef)
DGG <- ggplot(chunkdef, aes(DefRate, DefScore)) + geom_smooth(method = "lm", color = "blue", formula = y~x) + geom_point() + xlab("Defensive Rating") + ylab("Defense Points Allowed")
print(DGG)
summary(defgraph)

```

```{r}
library(ggplot2)
chunkoff <- read.csv("OffGraph.csv")
offgraph <- lm(OffScore ~ OffRate, data = chunkoff)
OGG <- ggplot(chunkoff, aes(OffRate, OffScore)) + geom_smooth(method = "lm", color = "blue", formula = y~x) + geom_point() + xlab("Offensive Rating") + ylab("Offense Points Scored")
print(OGG)
summary(offgraph)
```


It can be shown that there is a very correlations with the ratings and the points per game.  This could be helpful in predicting the outcomes of the games.

## Testing

Using the data from the data sets as well as the regression statistics for the two lines that were plotted, several tests will be run to determine how well the ratings predict future games.  The tests are as follows:

1.  Taking the sum of the differences between the two teams' offensive and defensive rating.  This number will be multiplied by 100 and compared to the line.  If the number is more than the line, the calculation will predict the away team.  If the number is lower, the home team will be predicted.
2.  Using the regression model, the equation will assign a score for offense and a score for defense for each team, We can test the sum of the differences similarly to test 1.
3.  Using the filtered data, compare the results year by year to see if a) there is any consistency to the data and b) if there are any trends.
4.  Filtering the data in different weeks of every year so that it is possible that the results get better as the season progresses and more data for each team is produced.
5.  Assigning a designation to each predictor by the following :Home team favorite, home team underdog, away team favorite, away team underdog, neutral site games.  This will determine if there is any favoritism towards home vs away or underdog vs favorite.
6.  Using the linear regression model to predict the number of points each team will score and thus be able to predict the outcome of an Over/Under bet.

## Results

Test 1  By just doing the simple calculation as noted, the resulting record was 2892 wins and 2702 losses.  This results in a success rate of 51.7%.  
Test 2  By using the equation SCORE = RATING - 0.5236/0.01415 which was derived from the average of the two regression line equations, the ratings were converted to predicted scores.  Once the sum of the differences were calculated with the newly derived scores, this was compared to the spread.  The result was 2892 wins and 2702 losses.  Success rate = 51.7%.
Test 3 The results in test 1 were filtered by year to see if there were any patterns that could be determined:

```{r}
library(dplyr)
yearresults <- read.csv("YearData.csv")
yearresults <- select(yearresults, YearDate, WinPct)
print(yearresults)
```



Test 4  The results in test 1 filtered by weekly result to see if the data gets better as the season progresses:

```{r}
weekresults <- read.csv("WeekData.csv")
weekplot <- ggplot(weekresults, aes(GameWeek, WinPct)) + geom_line() + geom_hline(aes(yintercept = 0.524), color = "green") + xlab("Week Number") + ylab("Bet Win Percentage")
weekresults <- select(weekresults, GameWeek, WinPct)
print(weekplot)
```

Test 5 - Filtering the results in Test 1 to determine if there are better results for being the home or away team as well as if the team picked was the favorite or the underdog:

```{r}
favdogresults <- read.csv("FavDog.csv")

print(favdogresults)
```

Test 6 - Using the regression to predict a score that would be over or under the predicted Over/Under number resulted in 1460 wins and 1527 losses.  This is a success rate of 48.9%

## Findings

1.  Overall this method cannot accurately predict outcomes of football games at a success rate that is equitible to the baseline of 52.4%
2.  Even though the regression model is highly correlated when comparing the proprietary ratings and the points per game, it does a very poor job of predicting the outcome of Over/Under bets (less than 49% success).
3.  It appears that the prediction that the model will get better at predicting games as the season goes on is valid.  In four of the last seven weeks of the season, the results are better than 53% (including a staggering 55.8% in week 13!).  Only one week in the first eight surpassed the 52.4% threshold.
4.  The data does show evidence that the model does better at picking away teams as winners against the spread versus the home team (53% vs 50%).  This could be attributed to the fact that oddsmakers will add points to the line favoring the home team just because they are playing at home.  Remember that the algorithm does not take this into account.

## What's Next

1.  There needs to be an understanding as to why the regression model did not accurately predict spread and Over/Under wagers.  One would think that there would be more success since there was high correlation between points and the ratings, the results didn't pan out.  This is evident in the plots below where the predictions were plotted against the actual scores for the home and away teams.  If the predictions were good, the plot would take more of a linear shape.  The plots below do not seems close to what is sought after.

```{r}
library(tidyr)
CCSL <- read.csv("Capstone CFA Scores and Lines.csv")
CCSL <- separate(CCSL, Score, c("AwayScore", "HomeScore"), sep = "-")
ScorevPred <- select(CCSL, Week, ATOR, ATDR, HTOR, HTDR, AwayScore, HomeScore)
ScorevPred <- mutate(ScorevPred, ATOS = (ATOR - 0.5236) / 0.01415)
ScorevPred <- mutate(ScorevPred, ATDS = (ATDR - 0.5236) / 0.01415)
ScorevPred <- mutate(ScorevPred, HTOS = (HTOR - 0.5236) / 0.01415)
ScorevPred <- mutate(ScorevPred, HTDS = (HTDR - 0.5236) / 0.01415)
ScorevPred <- mutate(ScorevPred, AwayPred = (ATOS + HTDS) / 2)
ScorevPred <- mutate(ScorevPred, HomePred = (HTOS + ATDS) / 2)
ScorevPred$AwayScore <- as.numeric(ScorevPred$AwayScore)
ScorevPred$HomeScore <- as.numeric(ScorevPred$HomeScore)
HPvS <- ggplot(ScorevPred, aes(HomePred, HomeScore)) + geom_point() + xlab("Home Score Prediction") + ylab("Actual Home Score") + scale_x_continuous(breaks = seq(0,60, by = 5)) + scale_y_continuous(breaks = seq(0,60, by = 5))
APvS <- ggplot(ScorevPred, aes(AwayPred, AwayScore)) + geom_point() + xlab("Away Score Prediction") + ylab("Actual Away Score") + scale_x_continuous(breaks = seq(0,60, by = 5)) + scale_y_continuous(breaks = seq(0,60, by = 5))
print(HPvS)
print(APvS)
```



It is understood that injuries, schedule strength and weather could play roles in a particular game's outcome.  It is still surprising that the results were so poor.

2.  The ratings need to be analyzed week over week.  It is understood that most of the teams play an opponent that is not in Division 1-A.  The result is a lopsided score which will result in lopsided ratings.  What would happen if the best and worst ratings for each team were eliminated?  Could this improve the findings?
3.  Do more work to understand the poor results when picking the home team.  Should the calculation add points to take into account "Home Field Advantage", like the oddsmakers do?  Will this skew the results so that more home teams results are better?
4.  Is there a way to fine tune the ratings to have a better result.  Can adjusting the calculations within the ratings make a difference?
5. Is there a way to improve the predictions in earlier weeks?  The charts below show the same prediction vs actual score for the home team.  Except it is broken out into which week in the season the particular game occurred:

```{r}

FHPvS <- ggplot(ScorevPred, aes(HomePred, HomeScore)) + geom_point() + xlab("Home Score Prediction") + ylab("Actual Home Score") + facet_wrap( ~ Week, ncol = 3) + scale_x_continuous(breaks = seq(0,60, by = 10)) + scale_y_continuous(breaks = seq(0,60, by = 10))
print(FHPvS)

```

There is some indication when looking at this breakdown of weekly data, the graphs for weeks 2-6 are not very tight.  Meaning that there is less correlation.  Therefore, the predictive ability is not good.  It appears that weeks 11-13, plus the bowl games have a much better appearance of a linear function.  This also proves that with more data, there is more success in prediction.
